'use strict';

var app = angular.module('HibiApp',
  [ 'ui.router'
  , 'angular.markdown'
  , 'ui.sortable'
  , 'ng.group'
  , 'app.models'
  , 'app.services'
  , 'app.controllers'
  , 'app.directives'
  , 'app.filters'
  ])
.config(function ($httpProvider, httpErrorHandler) {
  $httpProvider.interceptors.push(httpErrorHandler);
})
.config(function ($stateProvider) {
  $stateProvider
    .state('tasks', {
      url: '/tasks?days',
      controller: 'TasksCtrl',
      resolve: {
        tasks: function ($stateParams, Tasks) {
          var params = {}, days = $stateParams.days;
          if (days !== null) {
            if (/^[0-9]+$/.test(days)) {
              params.days = Number(days);
            } else {
              throw "days must be numeric!";
            }
          }
          return Tasks.all(params).then(function (tasks) {
            tasks.sort(function (task1, task2) {
              var order1 = task1.task.order, order2 = task2.task.order;
              if (order1 < order2) return -1;
              if (order1 > order2) return 1;
              return 0;
            });
            return tasks;
          });
        }
      },
      templateUrl: '@{TemplateOldTasksR}'
    })
})
.run(function ($rootScope, Billboard) {
  $rootScope.$on('$stateChangeError', function (event, toState, toParams, fromState, fromParams, error) {
    Billboard.error(error, {timeout: 10000});
  });
})
.value('messageFromServer', #{toJSON mmsg})
.value('defaultTaskSchedule', #{toJSON Once})
.run(function (Billboard, messageFromServer) {
  if (messageFromServer) {
    Billboard.success(messageFromServer, {timeout: 10000});
  }
});


app.filter('scheduleLabel', function () {
  var labels = {
    #{toJSON Once}: '',
    #{toJSON Daily}: '♳',
    #{toJSON Weekly}: '♹',
    #{toJSON Fortnightly}: '♹♹'
  };
  return function (schedule) {
    return labels[schedule];
  };
});
