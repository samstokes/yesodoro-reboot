$(function () {
  var container = $('##{widgetId}'),
      handle = container.find('.notes-handle'),
      counter = handle.find('.counter'),
      indicator = handle.find('.indicator'),
      detail = container.find('.notes-detail'),
      notes = container.find('ol.notes'),
      template = container.find('.note-template'),
      form = container.find('form'),
      noteField = form.find('textarea');

  function localSave(data) {
    var noteLi = $('<li class="note">').html(renderNote(data[1]));
    notes.append(noteLi);
    form.clearForm();

    var numNotes = notes.find('li').length;
    counter.html(numNotes);
    handle.removeClass('empty');

    noteField.focus();
  }

  function renderNote(note) {
    function paras(str) {
      return "<p>" + str.replace(/\n\n/g, "<\p><p>") + "<\p>";
    }
    return template.clone().removeClass('hidden')
      .find('.body').html(paras(note.body)).end();
  }

  handle.click(function () {
    detail.slideToggle('fast', function () {
      if (detail.css('display') === 'none') {
        indicator.html('☞');
      } else {
        indicator.html('☟');
      }
    });
  });

  form.ajaxForm({
    success: localSave
  });
});
